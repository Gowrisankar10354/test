<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 MQTT Controller</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; }
        h1, h2 { color: #333; }
        input, textarea, button { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ddd; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #0056b3; }
        #messages { height: 200px; overflow-y: scroll; border: 1px solid #ddd; padding: 10px; background-color: #fafafa; white-space: pre-wrap; margin-top: 10px; border-radius: 4px; }
        .status { padding: 10px; margin-bottom: 20px; border-radius: 4px; color: white; text-align: center; font-weight: bold; }
        .status.connected { background-color: #28a745; }
        .status.disconnected { background-color: #dc3545; }
    </style>
</head>
<body>

<div class="container">
    <h1>ESP32 MQTT Web Controller üåê</h1>
    <div id="connection-status" class="status disconnected">Disconnected</div>

    <h2>Publish Message</h2>
    <input type="text" id="publish-topic" value="esp32/s3/commands">
    <textarea id="publish-payload" placeholder="Enter message payload here..."></textarea>
    <button id="publish-button">Send Message</button>

    <h2>Subscribe to Topic</h2>
    <input type="text" id="subscribe-topic" value="esp32/s3/status">
    <button id="subscribe-button">Subscribe</button>

    <h2>Received Messages</h2>
    <div id="messages"></div>
</div>

<script>
    // --- Configuration ---
    // IMPORTANT: Use wss:// for secure websockets, required by modern browsers
    // --- Configuration ---
// Protocol is ws:// (unsecured) or wss:// (secured)
// Use the IP address of your broker and its WebSocket port (e.g., 9001 for Mosquitto)
const brokerUrl = 'wss://innovanext.ddns.net:8884', {
    clientId: 'mqtt-web-client-' + Math.random().toString(16).substr(2, 8),
    // Add your username and password here
    username: 'sankar_mqtt',
    password: 'sankar@2006',
    protocolVersion: 4, // MQTT v3.1.1
    reconnectPeriod: 2000,
};

    // --- DOM Elements ---
    const statusElement = document.getElementById('connection-status');
    const messagesElement = document.getElementById('messages');
    const pubTopicInput = document.getElementById('publish-topic');
    const pubPayloadInput = document.getElementById('publish-payload');
    const pubButton = document.getElementById('publish-button');
    const subTopicInput = document.getElementById('subscribe-topic');
    const subButton = document.getElementById('subscribe-button');

    // --- MQTT Client Logic ---
    logMessage('Connecting to broker...');
    const client = mqtt.connect(brokerUrl, options);

    client.on('connect', () => {
        statusElement.textContent = 'Connected';
        statusElement.className = 'status connected';
        logMessage('Successfully connected to MQTT broker!');
    });

    client.on('close', () => {
        statusElement.textContent = 'Disconnected';
        statusElement.className = 'status disconnected';
        logMessage('Disconnected from broker.');
    });

    client.on('error', (err) => {
        logMessage(`Error: ${err.message}`);
        client.end();
    });

    // This function is called when a message is received
    client.on('message', (topic, payload) => {
        const message = payload.toString();
        logMessage(`[${topic}]: ${message}`);
    });

    // --- Button Event Listeners ---
    pubButton.addEventListener('click', () => {
        const topic = pubTopicInput.value;
        const payload = pubPayloadInput.value;
        if (topic && payload) {
            client.publish(topic, payload);
            logMessage(`Published to [${topic}]: ${payload}`);
        }
    });

    subButton.addEventListener('click', () => {
        const topic = subTopicInput.value;
        if (topic) {
            client.subscribe(topic, (err) => {
                if (!err) {
                    logMessage(`Successfully subscribed to [${topic}]`);
                } else {
                    logMessage(`Subscription error: ${err}`);
                }
            });
        }
    });
    
    // --- Helper function ---
    function logMessage(message) {
        const now = new Date();
        const timestamp = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;
        messagesElement.innerHTML += `[${timestamp}] ${message}<br>`;
        messagesElement.scrollTop = messagesElement.scrollHeight; // Auto-scroll
    }

</script>
</body>
</html>
